---
phase: 01-foundation-infrastructure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/optimize-videos.sh
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "FFmpeg script can compress a video to under 5MB WebM"
    - "FFmpeg script can compress a video to under 5MB MP4"
    - "Source videos folder is gitignored"
    - "Optimized videos folder exists for committed outputs"
  artifacts:
    - path: "scripts/optimize-videos.sh"
      provides: "Video compression script"
      contains: "ffmpeg"
    - path: ".gitignore"
      provides: "Git ignore rules"
      contains: "videos-source"
  key_links:
    - from: "scripts/optimize-videos.sh"
      to: "static/videos/"
      via: "output path"
      pattern: "static/videos"
    - from: "scripts/optimize-videos.sh"
      to: "ffmpeg"
      via: "command invocation"
      pattern: "ffmpeg -i"
---

<objective>
Create video optimization pipeline with FFmpeg presets.

Purpose: Enable consistent video compression workflow producing web-optimized files under 5MB.
Output: Shell script that compresses any video to WebM and MP4 with appropriate quality settings.
</objective>

<execution_context>
@/Users/adicenzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adicenzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create video optimization script and folder structure</name>
  <files>
    scripts/optimize-videos.sh
    .gitignore
  </files>
  <action>
    1. Create directory structure:
       ```bash
       mkdir -p scripts
       mkdir -p static/videos
       mkdir -p static/images
       mkdir -p videos-source
       ```

    2. Create scripts/optimize-videos.sh:
       ```bash
       #!/bin/bash
       # Video optimization script for NBRS website
       # Produces web-optimized WebM (primary) and MP4 (fallback) under 5MB
       #
       # Usage: ./scripts/optimize-videos.sh <input-file> <output-name>
       # Example: ./scripts/optimize-videos.sh videos-source/hero.mov hero

       set -e

       INPUT="$1"
       OUTPUT="$2"

       if [ -z "$INPUT" ] || [ -z "$OUTPUT" ]; then
         echo "Usage: ./scripts/optimize-videos.sh <input-file> <output-name>"
         echo "Example: ./scripts/optimize-videos.sh videos-source/hero.mov hero"
         echo ""
         echo "This script creates:"
         echo "  static/videos/<output-name>.webm  (VP9, primary format)"
         echo "  static/videos/<output-name>.mp4   (H.264, fallback)"
         echo "  static/images/<output-name>-poster.webp (first frame)"
         exit 1
       fi

       if [ ! -f "$INPUT" ]; then
         echo "Error: Input file '$INPUT' not found"
         exit 1
       fi

       # Check for ffmpeg
       if ! command -v ffmpeg &> /dev/null; then
         echo "Error: ffmpeg is not installed"
         echo "Install with: brew install ffmpeg"
         exit 1
       fi

       # Create output directories if they don't exist
       mkdir -p static/videos
       mkdir -p static/images

       echo "Optimizing: $INPUT -> $OUTPUT"
       echo ""

       # WebM VP9 (primary - better compression, modern browsers)
       # CRF 30 = good compression while maintaining quality
       # -b:v 0 = quality-based encoding (let CRF control quality)
       # scale=1920:-2 = max 1920px wide, height divisible by 2
       # -an = no audio (background videos)
       echo "[1/3] Creating WebM (VP9)..."
       ffmpeg -i "$INPUT" \
         -c:v libvpx-vp9 \
         -crf 30 \
         -b:v 0 \
         -vf "scale=1920:-2" \
         -an \
         -movflags +faststart \
         -y \
         "static/videos/${OUTPUT}.webm"

       # MP4 H.264 (fallback - universal compatibility)
       # CRF 23 = high quality (lower = better quality, larger file)
       # preset slow = better compression (takes longer)
       # faststart = progressive loading (starts playing before fully downloaded)
       echo "[2/3] Creating MP4 (H.264)..."
       ffmpeg -i "$INPUT" \
         -c:v libx264 \
         -crf 23 \
         -preset slow \
         -vf "scale=1920:-2" \
         -an \
         -movflags +faststart \
         -y \
         "static/videos/${OUTPUT}.mp4"

       # Poster image from first frame
       echo "[3/3] Creating poster image..."
       ffmpeg -i "$INPUT" \
         -vframes 1 \
         -vf "scale=1920:-2" \
         -q:v 2 \
         -y \
         "static/images/${OUTPUT}-poster.webp"

       echo ""
       echo "Done! Created:"
       ls -lh "static/videos/${OUTPUT}.webm" "static/videos/${OUTPUT}.mp4" "static/images/${OUTPUT}-poster.webp"

       # File size check
       echo ""
       WEBM_SIZE=$(stat -f%z "static/videos/${OUTPUT}.webm" 2>/dev/null || stat -c%s "static/videos/${OUTPUT}.webm")
       MP4_SIZE=$(stat -f%z "static/videos/${OUTPUT}.mp4" 2>/dev/null || stat -c%s "static/videos/${OUTPUT}.mp4")
       MAX_SIZE=$((5 * 1024 * 1024))  # 5MB in bytes

       if [ "$WEBM_SIZE" -gt "$MAX_SIZE" ]; then
         echo "WARNING: WebM is larger than 5MB. Consider increasing CRF or reducing resolution."
       fi

       if [ "$MP4_SIZE" -gt "$MAX_SIZE" ]; then
         echo "WARNING: MP4 is larger than 5MB. Consider increasing CRF or reducing resolution."
       fi
       ```

    3. Make script executable:
       ```bash
       chmod +x scripts/optimize-videos.sh
       ```

    4. Update .gitignore (create if doesn't exist, or append):
       Add these lines:
       ```
       # Video source files (large, unoptimized)
       videos-source/

       # Node modules
       node_modules/

       # Build output
       build/
       .svelte-kit/

       # Environment files
       .env
       .env.*
       !.env.example

       # OS files
       .DS_Store
       Thumbs.db
       ```

    5. Create a placeholder README in videos-source:
       Create videos-source/.gitkeep or videos-source/README.md:
       ```
       # Video Source Files

       Place source video files here for optimization.
       This folder is gitignored - source files are not committed.

       Run: ./scripts/optimize-videos.sh <input-file> <output-name>

       Example:
         ./scripts/optimize-videos.sh hero-raw.mov hero

       Outputs go to static/videos/ (committed) and static/images/ (committed).
       ```
  </action>
  <verify>
    1. Check script is executable: `ls -la scripts/optimize-videos.sh`
    2. Run script without args to see usage: `./scripts/optimize-videos.sh`
    3. Verify .gitignore contains videos-source/: `grep videos-source .gitignore`
    4. Verify directories exist: `ls -la static/videos static/images videos-source`
  </verify>
  <done>
    - scripts/optimize-videos.sh exists and is executable
    - Running without args shows usage instructions
    - videos-source/ is gitignored
    - static/videos/ and static/images/ directories exist for outputs
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify FFmpeg availability and document workflow</name>
  <files>
    scripts/optimize-videos.sh
  </files>
  <action>
    1. Check if FFmpeg is installed:
       ```bash
       ffmpeg -version
       ```

       If not installed, the script will fail with a helpful error message.
       User can install with: `brew install ffmpeg`

    2. Test script with a small test video (optional - only if user has one):
       If a test video is available in videos-source/:
       ```bash
       ./scripts/optimize-videos.sh videos-source/test.mov test
       ```

       This verifies the full pipeline works.

    3. If no test video available, verify script syntax:
       ```bash
       bash -n scripts/optimize-videos.sh  # Syntax check only
       ```

    Note: The script includes:
    - Input validation (checks file exists)
    - FFmpeg availability check
    - Output directories auto-creation
    - File size warnings if output exceeds 5MB
    - Usage instructions when run without args
  </action>
  <verify>
    `ffmpeg -version` returns version info (or note that user needs to install)
    `bash -n scripts/optimize-videos.sh` returns no errors (syntax valid)
    `./scripts/optimize-videos.sh` (no args) shows usage instructions
  </verify>
  <done>
    - FFmpeg availability is documented
    - Script passes syntax validation
    - Workflow is ready for video processing
  </done>
</task>

</tasks>

<verification>
1. scripts/optimize-videos.sh exists and is executable
2. Script shows usage when run without arguments
3. .gitignore includes videos-source/
4. Directory structure exists: static/videos/, static/images/, videos-source/
5. Script contains WebM VP9 and MP4 H.264 encoding commands
6. Script includes file size warning logic
</verification>

<success_criteria>
- FFmpeg script exists at scripts/optimize-videos.sh
- Script produces WebM (VP9) and MP4 (H.264) outputs
- Script generates poster image from first frame
- Source videos folder (videos-source/) is gitignored
- Output folders (static/videos/, static/images/) exist for committed files
- Script includes helpful usage instructions and error handling
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md`
</output>
